angular.module("CollectionPresenter.Settings", [])

.constant('settings', {
	baseServiceUrl: 'http://localhost/test',
	apiKey: ''
});
angular.module("CollectionPresenter", [
	'ngRoute',
	'CollectionPresenter.ApiClient',
	'CollectionPresenter.Main',
	'CollectionPresenter.Item',
	'CollectionPresenter.List'
])

.controller("collectionsController", function ($scope, collections) {
	$scope.appName = "Collection";
	if ($scope.collections) return;
	collections.get({$expand: 'categories'}, function(data) {
		$scope.collections = data.value;
	});
})

.directive("titleBar", function() {
	return {
		templateUrl: 'templates/titleBarTemplate.html',
		restrict: 'E',
		controller: "collectionsController"
	};
})

.directive("categoriesSidebar", function() {
	return {
		templateUrl: 'templates/categoriesSidebarTemplate.html',
		restrict: 'E',
		controller: "collectionsController"
	};
})

.directive("itemPresenter", function() {
	return {
		templateUrl: 'templates/itemTemplate.html',
		restrict: 'E',
		scope: {
			item: '='
		}
	};
})

.directive("itemList", function() {
	return {
		templateUrl: 'templates/itemsListTemplate.html',
		restrict: 'E'
	};
});


angular.module("CollectionPresenter.ApiClient", ['ngResource', 'CollectionPresenter.Settings'])

.factory("collections", function($resource, settings) {
	var odataUrl = settings.baseServiceUrl + '/odata/Collections(:id)';
	return $resource(odataUrl, {}, {
		'getCategories': { method: "GET", url: odataUrl + "/categories" },
		'getItems': { method: "GET", url: odataUrl + "/items" }
	});
})

.factory("categories", function($resource, settings) {
	var odataUrl = settings.baseServiceUrl + '/odata/Categories(:id)';
	return $resource(odataUrl, {}, {
		'getItems': { method: "GET", url: odataUrl + "/items" }
	});
})

.factory("items", function($resource, settings) {
	var odataUrl = settings.baseServiceUrl + '/odata/Items(:id)';
	return $resource(odataUrl);	
});
angular.module('CollectionPresenter.Main', ['ngRoute'])

.config(['$routeProvider', function($routeProvider) {
  $routeProvider.when('/', {
    templateUrl: 'views/Main.html',
    controller: 'MainController'
  });
}])

.controller("MainController", function($scope, CollectionItems) {
	CollectionItems.query(function (data) {
		$scope.collections = data.collections;
	});
});
angular.module('CollectionPresenter.Item', ['ngRoute'])

.config(['$routeProvider', function($routeProvider) {
  $routeProvider.when('/item/:id', {
    templateUrl: 'views/item.html',
    controller: 'ItemController'
  }).otherwise({
  	redirectTo: '/'
  });
}])

.controller("ItemController", function($scope, $routeParams, items) {
	items.get({ id: $routeParams.id }, function (data) {
		$scope.item = data.value;
	});
});
angular.module('CollectionPresenter.List', ['ngRoute'])

.config(['$routeProvider', function($routeProvider) {
  $routeProvider.when('/category/:id', {
    templateUrl: 'views/list.html',
    controller: 'CategoryController'
  }).when('/collection/:id', {
    templateUrl: 'views/list.html',
    controller: 'CollectionController'
  }).otherwise({
  	redirectTo: '/'
  });
}])

.controller("CategoryController", function($scope, $routeParams, categories) {
  $scope.title = "Category";
  categories.getItems({ id: $routeParams.id }, function(data) {
    $scope.items = data.value;
  });
})

.controller("CollectionController", function($scope, $routeParams, collections, items) {
  var lastSelected = null;

  $scope.title = "Collection";
  collections.getItems({ id: $routeParams.id }, function(data) {
    $scope.items = data.value;
  });

  $scope.selectItem = function(item) {
    items.get({ id: item.id, $expand: 'description,characteristics' }, function(data) {
      $scope.selectedItem = data;

      if (lastSelected)
        lastSelected.selected = false;
      item.selected = true;
      lastSelected = item;
    });
  };
});